# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#runstepsif

name: "Gitcord"
description: "expand GitHub into Discord"

inputs:
  payload:
    description: "GitHub event payload passed into Gitcord stdin"
    required: true
  github-token:
    description: "GitHub token"
    required: true
  discord-token:
    description: "Discord token"
    required: true
  discord-channel-id:
    description: "Discord channel ID"
    required: true

runs:
  using: "composite"
  steps:
    - name: Validate GitHub event payload
      id: event_payload
      # See:
      # https://github.com/mkungla/actions-set-text-output/blob/414dd008c8ad6a77fb0fe56e62076111ca59132b/action.yml

      shell: bash
      env:
        event_payload: ${{ inputs.payload }}
      run: |
        if [[ -z "${{ inputs.payload }}" ]]; then
          echo "Gitcord: GitHub event payload is empty"
          exit 1
        fi

        event_payload="${event_payload//'%'/'%25'}"
        event_payload="${event_payload//$'\n'/'%0A'}"
        event_payload="${event_payload//$'\r'/'%0D'}"
        echo "::set-output name=payload::$event_payload"

    - name: Setup Go
      uses: actions/setup-go@v3
      with:
        go-version: "1.19"

    - name: Gitcord
      shell: bash
      run: |
        go install github.com/ethanthatonekid/gitcord@latest
        echo "${{ steps.event_payload.outputs.payload }}" | gitcord
      env:
        GITHUB_TOKEN: "${{ inputs.github-token }}"
        DISCORD_TOKEN: "${{ inputs.discord-token }}"
        DISCORD_CHANNEL_ID: "${{ inputs.discord-channel-id }}"
